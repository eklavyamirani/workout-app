name: Promote to Production

on:
  workflow_dispatch:

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - run: npm install -g vercel

      - name: Get latest staging deployment
        id: staging
        run: |
          URL=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep Preview | head -1 | grep -oP 'https://\S+')
          echo "url=$URL"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Alias to production domain
        run: vercel alias ${{ steps.staging.outputs.url }} ${{ vars.PRODUCTION_DOMAIN }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
